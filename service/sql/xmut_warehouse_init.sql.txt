-- 2. 使用该数据库
USE xmut_warehouse;

-- 3. 创建表（按无外键→有外键顺序创建）
-- 3.1 用户表（xmut_user）
CREATE TABLE IF NOT EXISTS xmut_user (
                                         id VARCHAR(36) NOT NULL COMMENT 'UUID主键',
                                         username VARCHAR(50) NOT NULL COMMENT '登录账号（唯一）',
                                         password VARCHAR(100) NOT NULL COMMENT 'BCrypt加密后密码',
                                         nickname VARCHAR(50) NOT NULL COMMENT '用户昵称',
                                         role TINYINT(1) NOT NULL COMMENT '1-超级管理员，2-信息管理员',
                                         status TINYINT(1) NOT NULL COMMENT '0-禁用，1-启用',
                                         phone VARCHAR(20) DEFAULT NULL COMMENT '联系方式',
                                         email VARCHAR(50) DEFAULT NULL COMMENT '邮箱',
                                         create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
                                         last_login_time DATETIME DEFAULT NULL COMMENT '最后登录时间',
                                         PRIMARY KEY (id),
                                         UNIQUE INDEX idx_username (username) COMMENT '账号唯一索引',
                                         INDEX idx_role_status (role, status) COMMENT '角色+状态索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统用户表';

-- 3.2 企业表（xmut_enterprise）
CREATE TABLE IF NOT EXISTS xmut_enterprise (
                                               id VARCHAR(36) NOT NULL COMMENT 'UUID主键',
                                               name VARCHAR(100) NOT NULL COMMENT '企业名称',
                                               address VARCHAR(255) NOT NULL COMMENT '企业地址',
                                               contact VARCHAR(50) NOT NULL COMMENT '企业联系人',
                                               phone VARCHAR(20) NOT NULL COMMENT '企业联系电话',
                                               remark VARCHAR(500) DEFAULT NULL COMMENT '企业备注',
                                               update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后更新时间',
                                               PRIMARY KEY (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='企业信息表（单企业）';

-- 3.3 仓库表（xmut_warehouse）
CREATE TABLE IF NOT EXISTS xmut_warehouse (
                                              id VARCHAR(36) NOT NULL COMMENT 'UUID主键',
                                              name VARCHAR(100) NOT NULL COMMENT '仓库名称（唯一）',
                                              address VARCHAR(255) NOT NULL COMMENT '仓库地址',
                                              manager VARCHAR(50) NOT NULL COMMENT '仓库负责人',
                                              phone VARCHAR(20) NOT NULL COMMENT '负责人电话',
                                              status TINYINT(1) NOT NULL COMMENT '0-禁用，1-启用',
                                              enterprise_id VARCHAR(36) DEFAULT NULL COMMENT '关联企业ID',
                                              create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
                                              PRIMARY KEY (id),
                                              UNIQUE INDEX idx_warehouse_name (name) COMMENT '仓库名称唯一索引',
                                              FOREIGN KEY (enterprise_id) REFERENCES xmut_enterprise(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='仓库信息表';

-- 3.4 货品类别表（xmut_goods_category）
CREATE TABLE IF NOT EXISTS xmut_goods_category (
                                                   id VARCHAR(36) NOT NULL COMMENT 'UUID主键',
                                                   name VARCHAR(50) NOT NULL COMMENT '类别名称（唯一）',
                                                   remark VARCHAR(200) DEFAULT NULL COMMENT '类别备注',
                                                   create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
                                                   PRIMARY KEY (id),
                                                   UNIQUE INDEX idx_category_name (name) COMMENT '类别名称唯一索引'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='货品类别表';

-- 3.5 货品表（xmut_goods）
CREATE TABLE IF NOT EXISTS xmut_goods (
                                          id VARCHAR(36) NOT NULL COMMENT 'UUID主键',
                                          name VARCHAR(100) NOT NULL COMMENT '货品名称',
                                          price DECIMAL(10,2) NOT NULL COMMENT '货品单价',
                                          pic VARCHAR(255) DEFAULT NULL COMMENT '货品图片路径',
                                          stock INT(11) NOT NULL DEFAULT 0 COMMENT '货品库存',
                                          category_id VARCHAR(36) NOT NULL COMMENT '关联类别ID',
                                          warehouse_id VARCHAR(36) NOT NULL COMMENT '关联仓库ID',
                                          status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '0-下架，1-上架',
                                          remark VARCHAR(200) DEFAULT NULL COMMENT '货品备注',
                                          create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
                                          PRIMARY KEY (id),
                                          INDEX idx_warehouse_category (warehouse_id, category_id, status) COMMENT '仓库+类别+状态索引',
                                          INDEX idx_stock (stock) COMMENT '库存索引',
                                          FOREIGN KEY (category_id) REFERENCES xmut_goods_category(id) ON DELETE CASCADE,
                                          FOREIGN KEY (warehouse_id) REFERENCES xmut_warehouse(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='货品信息表';

-- 3.6 出入库记录表（xmut_in_out_record）
CREATE TABLE IF NOT EXISTS xmut_in_out_record (
                                                  id VARCHAR(36) NOT NULL COMMENT 'UUID主键',
                                                  goods_id VARCHAR(36) NOT NULL COMMENT '关联货品ID',
                                                  warehouse_id VARCHAR(36) NOT NULL COMMENT '关联操作仓库ID',
                                                  type TINYINT(1) NOT NULL COMMENT '1-入库，2-出库，3-调货',
                                                  related_warehouse_id VARCHAR(36) DEFAULT NULL COMMENT '调货目标仓库ID',
                                                  quantity INT(11) NOT NULL COMMENT '操作数量（正数）',
                                                  contact_person VARCHAR(50) NOT NULL COMMENT '对接人',
                                                  contact_phone VARCHAR(20) NOT NULL COMMENT '对接人电话',
                                                  remark VARCHAR(500) DEFAULT NULL COMMENT '操作备注',
                                                  operate_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
                                                  operator_id VARCHAR(36) NOT NULL COMMENT '操作人ID（关联用户表）',
                                                  PRIMARY KEY (id),
                                                  INDEX idx_goods_warehouse_time (goods_id, warehouse_id, operate_time) COMMENT '货品+仓库+时间索引',
                                                  INDEX idx_operator_time (operator_id, operate_time) COMMENT '操作人+时间索引',
                                                  FOREIGN KEY (goods_id) REFERENCES xmut_goods(id) ON DELETE CASCADE,
                                                  FOREIGN KEY (warehouse_id) REFERENCES xmut_warehouse(id) ON DELETE CASCADE,
                                                  FOREIGN KEY (operator_id) REFERENCES xmut_user(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='出入库及调货记录表';

-- 3.7 用户-仓库权限中间表（xmut_user_warehouse，加分项）
CREATE TABLE IF NOT EXISTS xmut_user_warehouse (
                                                   id VARCHAR(36) NOT NULL COMMENT 'UUID主键',
                                                   user_id VARCHAR(36) NOT NULL COMMENT '关联用户ID',
                                                   warehouse_id VARCHAR(36) NOT NULL COMMENT '关联仓库ID',
                                                   PRIMARY KEY (id),
                                                   UNIQUE INDEX idx_user_warehouse (user_id, warehouse_id) COMMENT '用户+仓库唯一索引',
                                                   FOREIGN KEY (user_id) REFERENCES xmut_user(id) ON DELETE CASCADE,
                                                   FOREIGN KEY (warehouse_id) REFERENCES xmut_warehouse(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户-仓库权限关联表';

-- 4. 插入测试数据
-- 4.1 超级管理员（密码：123456，已BCrypt加密）
INSERT INTO xmut_user (id, username, password, nickname, role, status)
VALUES ('1', 'admin', '$2a$10$8H9w4z6eQ7R3tY1uI2oP3aS4dF5gH6jK7lM8nO9pQ0rS1tU2vW3', '超级管理员', 1, 1);

-- 4.2 企业信息（单企业）
INSERT INTO xmut_enterprise (id, name, address, contact, phone)
VALUES ('1', 'XX科技有限公司', '北京市海淀区中关村科技园', '张三', '13800138000');

-- 4.3 测试仓库
INSERT INTO xmut_warehouse (id, name, address, manager, phone, status, enterprise_id)
VALUES ('1', '北京仓库', '北京市海淀区仓库路1号', '李四', '13900139000', 1, '1'),
       ('2', '上海仓库', '上海市浦东新区仓库路2号', '王五', '13700137000', 1, '1');

-- 4.4 测试货品类别
INSERT INTO xmut_goods_category (id, name, remark)
VALUES ('1', '电子产品', '手机、电脑等'),
       ('2', '办公用品', '打印机、纸张等');

-- 4.5 测试货品
INSERT INTO xmut_goods (id, name, price, stock, category_id, warehouse_id, status)
VALUES ('1', '智能手机', 3999.00, 100, '1', '1', 1),
       ('2', '笔记本电脑', 5999.00, 50, '1', '1', 1),
       ('3', 'A4打印纸', 25.00, 200, '2', '2', 1);

-- 脚本执行完成提示
SELECT '数据库初始化成功！' AS tip;